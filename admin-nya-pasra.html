<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin PASRA - Data Pendaftaran</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #006400;
            --color-primary-light: #e6ffe6;
            --color-text: #2c3e50;
            --color-background: #f8f9fa;
            --color-card-bg: #ffffff;
            --color-border: #cccccc;
            --color-danger-btn: #e74c3c;
            --color-view-btn: #007500;
            --color-view-btn-hover: #005000;
            --color-accent-text: #006400;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            margin: 0;
            padding: 30px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background-color: var(--color-card-bg);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        h1 {
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-primary-light);
            padding-bottom: 15px;
            margin-bottom: 30px;
            text-align: center;
            font-weight: 600;
        }
        
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            background-color: var(--color-primary-light);
            border-radius: 6px;
            border: 1px solid var(--color-border);
        }

        .data-count-display {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--color-text);
        }

        .data-count-display strong {
            color: var(--color-accent-text);
            font-size: 1.2em;
            margin-right: 5px;
        }
        
        .filter-buttons {
            display: flex;
            flex-wrap: wrap; 
            gap: 8px; 
        }

        .filter-btn {
            padding: 8px 15px;
            border: 1px solid var(--color-primary);
            border-radius: 4px;
            background-color: white;
            color: var(--color-primary);
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.1s, color 0.1s;
        }

        .filter-btn:hover {
            background-color: var(--color-primary-light);
        }

        .filter-btn.active {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }
        
        #pendaftaran-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1em;
            margin-top: 20px;
        }

        #pendaftaran-table th, #pendaftaran-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        #pendaftaran-table th {
            background-color: var(--color-primary);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        #pendaftaran-table tbody tr:hover {
            background-color: #f4f6f8;
        }
        
        #pendaftaran-table td:nth-child(4) { 
            text-align: center;
            width: 80px;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.1s; 
            margin: 3px;
        }

        .view-btn {
            background-color: var(--color-view-btn);
            color: white;
        }

        .view-btn:hover {
            background-color: var(--color-view-btn-hover);
        }

        .delete-btn {
            background-color: var(--color-danger-btn);
            color: white;
        }

        .delete-btn:hover {
            background-color: #c0392b;
        }
        
        .modal-overlay {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5); 
        }

        .modal-content {
            background-color: var(--color-card-bg);
            margin: 5% auto; 
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            transition: color 0.1s;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: var(--color-danger-btn);
            text-decoration: none;
            cursor: pointer;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 10px;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--color-primary);
            width: 150px;
            flex-shrink: 0;
        }
        
        .detail-value {
            flex-grow: 1;
            padding-left: 10px;
            word-wrap: break-word; 
        }
        
        .detail-link-group button {
            margin-right: 10px;
        }
        
        #auth-section, #logout-button, .modal-preview-overlay {
            display: none !important;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Dashboard Administrasi Lomba PASRA 2026</h1>
        
        <div id="data-section">
            
            <div class="header-controls">
                <div class="data-count-display">
                    <strong id="jumlah-data">0</strong> PENDAFTAR
                </div>
                <div class="filter-buttons" id="filter-container">
                    </div>
            </div>

            <div class="data-table-container">
                <table id="pendaftaran-table">
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>Kategori</th>
                            <th>Nama</th>
                            <th>Tinjau</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="pendaftaran-body">
                        <tr><td colspan="5" style="text-align: center;">Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>
    
    <div id="detailModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2>Detail Pendaftar <span id="detail-id"></span></h2>
            <hr>
            
            <div class="detail-row"><div class="detail-label">Kategori:</div> <div class="detail-value" id="detail-kategori"></div></div>
            <div class="detail-row"><div class="detail-label">Nama:</div> <div class="detail-value" id="detail-nama"></div></div>
            <div class="detail-row"><div class="detail-label">Pendidikan:</div> <div class="detail-value" id="detail-pendidikan"></div></div>
            <div class="detail-row"><div class="detail-label">Nomor WA:</div> <div class="detail-value" id="detail-wa"></div></div>
            <div class="detail-row"><div class="detail-label">Waktu Daftar:</div> <div class="detail-value" id="detail-waktu"></div></div>
            
            <h3>File Dokumen</h3>
            <div class="detail-link-group">
                <div class="detail-row"><div class="detail-label">Bukti Bayar:</div> <div class="detail-value" id="detail-bukti-bayar"></div></div>
                <div class="detail-row"><div class="detail-label">KTS/ID Card:</div> <div class="detail-value" id="detail-kts-card"></div></div>
                <div class="detail-row"><div class="detail-label">File Karya:</div> <div class="detail-value" id="detail-file-karya"></div></div>
            </div>
            
            <button class="delete-btn action-btn" id="modal-delete-btn" style="margin-top: 20px;">Hapus Data Ini</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        const SUPABASE_URL = 'https://kerltwgefpeqjicsxupo.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtlcmx0d2dlZnBlcWppY3N4dXBvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MTk3ODAsImV4cCI6MjA4MDk5NTc4MH0.86-Cl6cSe6OxhCzvI8qVOuZrAyS-UTi7RphMD2KEOX0'; 
        
        const BUCKET_NAME = 'pasra-lomba'; 
        const TABLE_NAME = 'pendaftaran';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const pendaftaranBody = document.getElementById('pendaftaran-body');
        const jumlahData = document.getElementById('jumlah-data');
        const filterContainer = document.getElementById('filter-container'); 
        
        const KATEGORI_OPTIONS = ['all', 'PUISI', 'ESAI', 'CERPEN', 'VIDIOGRAFI', 'BACAPUISI', 'DAI_MADURA'];
        let activeKategori = 'all'; 

        const detailModal = document.getElementById('detailModal');
        const modalDeleteBtn = document.getElementById('modal-delete-btn');
        let allPendaftarData = []; 

        function setupFilterButtons() {
            filterContainer.innerHTML = '';
            KATEGORI_OPTIONS.forEach(kategori => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.textContent = kategori === 'all' ? 'Semua Kategori' : kategori;
                btn.setAttribute('data-kategori', kategori);
                
                if (kategori === activeKategori) {
                    btn.classList.add('active');
                }

                btn.onclick = () => {
                    setActiveKategori(kategori);
                };
                filterContainer.appendChild(btn);
            });
        }
        
        function setActiveKategori(kategori) {
            activeKategori = kategori;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.querySelector(`.filter-btn[data-kategori="${kategori}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            fetchData();
        }

        async function fetchData() {
            pendaftaranBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Memuat data...</td></tr>'; 
            
            let query = supabaseClient
                .from(TABLE_NAME)
                .select('*')
                .order('timestamp', { ascending: false });

            if (activeKategori !== 'all') {
                query = query.eq('kategori', activeKategori);
            }

            const { data, error } = await query;

            pendaftaranBody.innerHTML = ''; 
            allPendaftarData = data || [];

            if (error) {
                pendaftaranBody.innerHTML = `<tr><td colspan="5" style="background-color:#f8d7da; color:#dc3545; font-weight:700;">Gagal memuat data: ${error.message}.</td></tr>`;
                jumlahData.textContent = '0';
                return;
            }

            if (data && data.length > 0) {
                data.forEach((pendaftar, index) => { 
                    const row = pendaftaranBody.insertRow();
                    
                    row.insertCell().textContent = index + 1; 
                    row.insertCell().textContent = pendaftar.kategori;
                    row.insertCell().textContent = pendaftar.nama;
                    
                    const reviewCell = row.insertCell();
                    reviewCell.innerHTML = `
                        <input 
                            type="checkbox" 
                            ${pendaftar.sudah_ditinjau ? 'checked' : ''} 
                            onchange="toggleReviewStatus(${pendaftar.id}, this.checked)"
                        />
                    `;

                    const actionCell = row.insertCell();
                    actionCell.innerHTML = `
                        <button class="view-btn action-btn" onclick="showDetail(${pendaftar.id})">Lihat Detail</button>
                    `;
                });

                jumlahData.textContent = data.length;
            } else {
                pendaftaranBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Belum ada data pendaftaran.</td></tr>';
                jumlahData.textContent = '0';
            }
        }
        
        async function toggleReviewStatus(id, isChecked) {
            
            const { error } = await supabaseClient
                .from(TABLE_NAME)
                .update({ sudah_ditinjau: isChecked }) 
                .eq('id', id);

            if (error) {
                console.error('Gagal memperbarui status tinjauan:', error);
                alert(`Gagal memperbarui status data ID ${id}: ${error.message}.`);
                
                const checkbox = document.querySelector(`input[type="checkbox"][onchange*="${id}"]`);
                if (checkbox) {
                    checkbox.checked = !isChecked;
                }
                return;
            }
            
            const pendaftarIndex = allPendaftarData.findIndex(p => p.id === id);
            if (pendaftarIndex !== -1) {
                allPendaftarData[pendaftarIndex].sudah_ditinjau = isChecked;
            }

            console.log(`Status tinjauan ID ${id} diubah menjadi: ${isChecked}`);
        }
        
        const createFileLink = (path, label) => {
            if (!path) return ' - '; 
            
            const { data: linkData } = supabaseClient.storage
                .from(BUCKET_NAME)
                .getPublicUrl(path);
                
            const publicUrl = linkData.publicUrl;
            
            return `
                <button 
                    class="view-btn action-btn" 
                    onclick="openFilePreview('${publicUrl}')"
                    title="Buka Pratinjau ${label}"
                >
                    Lihat File
                </button>
            `;
        };
        
        function showDetail(id) {
            const pendaftar = allPendaftarData.find(p => p.id === id);
            
            if (!pendaftar) {
                alert('Data pendaftar tidak ditemukan.');
                return;
            }
            
            const timeWIB = new Date(pendaftar.timestamp).toLocaleString('id-ID', {
                day: 'numeric', month: 'short', year: 'numeric', 
                hour: '2-digit', minute: '2-digit', second: '2-digit', 
                timeZone: 'Asia/Jakarta'
            });

            document.getElementById('detail-id').textContent = ''; 
            
            document.getElementById('detail-kategori').textContent = pendaftar.kategori;
            document.getElementById('detail-nama').textContent = pendaftar.nama;
            document.getElementById('detail-pendidikan').textContent = pendaftar.tingkat_pendidikan;
            document.getElementById('detail-wa').innerHTML = `<a href="https://wa.me/${pendaftar.nomor_wa}" target="_blank">${pendaftar.nomor_wa}</a>`;
            document.getElementById('detail-waktu').textContent = timeWIB;
            
            document.getElementById('detail-bukti-bayar').innerHTML = createFileLink(pendaftar.bukti_bayar_path, 'Bayar');
            document.getElementById('detail-kts-card').innerHTML = createFileLink(pendaftar.kts_path, 'Kartu');
            document.getElementById('detail-file-karya').innerHTML = createFileLink(pendaftar.karya_path, 'Karya');
            
            modalDeleteBtn.onclick = () => confirmDeleteFromModal(pendaftar);
            
            detailModal.style.display = 'block';
        }

        function closeModal() {
            detailModal.style.display = 'none';
        }

        function openFilePreview(url) {
            if (url) {
                window.open(url, '_blank');
            } else {
                console.error('URL file tidak ditemukan.');
            }
        }
        
        window.onclick = function(event) {
            if (event.target === detailModal) {
                closeModal();
            }
        }
        
        function confirmDeleteFromModal(pendaftar) {
            const { id, bukti_bayar_path, kts_path, karya_path } = pendaftar;
            
            if (confirm(`Apakah Anda yakin ingin menghapus data pendaftar dengan ID: ${id}? Tindakan ini akan menghapus data di database dan file di storage!`)) {
                
                const rowElement = Array.from(pendaftaranBody.rows).find(row => {
                    const pendaftarRow = allPendaftarData[row.rowIndex - 1]; 
                    return pendaftarRow && pendaftarRow.id === id;
                });
                
                closeModal();
                deleteData(id, bukti_bayar_path, kts_path, karya_path, rowElement);
            }
        }

        async function deleteData(id, bbPath, ktsPath, karyaPath, rowElement) {
            if (rowElement) rowElement.style.backgroundColor = '#fce3e7'; 
            
            const filesToDelete = [bbPath, ktsPath, karyaPath].filter(p => p && p !== 'null');
            
            let storageError = null;
            if (filesToDelete.length > 0) {
                const { error: storageErr } = await supabaseClient.storage
                    .from(BUCKET_NAME)
                    .remove(filesToDelete); 

                if (storageErr) {
                    storageError = storageErr;
                    console.error('Gagal menghapus file dari storage:', storageErr);
                }
            }
            
            const { error: dbError } = await supabaseClient
                .from(TABLE_NAME)
                .delete()
                .eq('id', id);

            if (dbError) {
                console.error('Gagal menghapus data dari tabel:', dbError);
                alert(`Gagal menghapus data pendaftar (ID ${id}) dari database: ${dbError.message}. Pastikan RLS Policy DELETE Anda benar.`);
                if (rowElement) rowElement.style.backgroundColor = ''; 
                return;
            }

            if (!dbError) {
                if (rowElement) rowElement.remove();
                
                allPendaftarData = allPendaftarData.filter(p => p.id !== id);
                jumlahData.textContent = allPendaftarData.length;
                
                fetchData();

                let successMessage = `Data pendaftar ID ${id} berhasil dihapus.`;
                if (storageError) successMessage += ` Peringatan: Gagal menghapus file di Storage.`;
                alert(successMessage);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            setupFilterButtons();
            fetchData();
        });
    </script>
</body>
</html>
